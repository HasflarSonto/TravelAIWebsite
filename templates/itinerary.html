{% extends "base.html" %}

{% block title %}Itinerary - Trip Planner{% endblock %}

{% block content %}
<div class="itinerary-header">
    <h1>YOUR TRIP ITINERARY</h1>
    <h2 id="trip-date-range"></h2>
</div>

<div class="itinerary-container">
    <div class="header-actions">
        <h1 class="itinerary-title">Your Trip</h1>
        <button class="ship-btn" onclick="window.location.href='/todos'">ðŸš€ Ship Itinerary</button>
    </div>
    
    <div id="itinerary-days">
        {% for day in trip_events %}
        <div class="day-container">
            <h2>Day {{ loop.index }} - {{ day.date }}</h2>
            <div class="activity-rows-container">
                {% for activity in day.activities %}
                <div class="activity-row" data-id="{{ activity.id }}">
                    <div class="activity-content">
                        <div class="activity-time">
                            <div class="time-block">
                                {{ activity.start_time }} to {{ activity.end_time }}
                            </div>
                        </div>
                        <div class="activity-details">
                            <h3>{{ activity.title }}</h3>
                            <p class="location">{{ activity.location }}</p>
                            <p class="cost">${{ activity.cost }}</p>
                        </div>
                        <div class="activity-actions">
                            <button class="edit-btn" onclick="editActivity('{{ activity.id }}')">Edit</button>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            <button class="add-btn" onclick="showAddModal('{{ day.date }}')">+ Add Activity</button>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal" class="modal">
    <div class="modal-content">
        <h2>Edit Event</h2>
        <form id="editForm">
            <input type="hidden" id="editActivityId">
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="editTitle" required>
            </div>
            <div class="form-group">
                <label>Start Time</label>
                <input type="time" id="editStartTime" required>
            </div>
            <div class="form-group">
                <label>End Time</label>
                <input type="time" id="editEndTime" required>
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="editLocation" required>
            </div>
            <div class="form-group">
                <label>Cost ($)</label>
                <input type="number" id="editCost" step="0.01" required>
            </div>
            <div class="button-group primary-actions">
                <button type="button" class="delete-btn" onclick="deleteActivity(document.getElementById('editActivityId').value)">Delete Event</button>
                <button type="submit" class="save-btn">Save Changes</button>
            </div>
            <div class="button-group secondary-actions" style="margin-top: 10px; justify-content: center;">
                <button type="button" class="cancel-btn" onclick="closeModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add New Event Modal -->
<div id="addModal" class="modal">
    <div class="modal-content">
        <h2>Add New Event</h2>
        <form id="addForm">
            <input type="hidden" id="addDayDate">
            <div class="form-group">
                <label>Title</label>
                <input type="text" id="addTitle" required>
            </div>
            <div class="form-group">
                <label>Start Time</label>
                <input type="time" id="addStartTime" required>
            </div>
            <div class="form-group">
                <label>End Time</label>
                <input type="time" id="addEndTime" required>
            </div>
            <div class="form-group">
                <label>Location</label>
                <input type="text" id="addLocation" required>
            </div>
            <div class="form-group">
                <label>Cost ($)</label>
                <input type="number" id="addCost" step="0.01" required>
            </div>
            <div class="button-group">
                <button type="submit" class="save-btn">Add Event</button>
                <button type="button" class="cancel-btn" onclick="closeAddModal()">Cancel</button>
            </div>
        </form>
    </div>
</div>

<!-- Add this new modal for showing generated todos -->
<div id="todosModal" class="modal">
    <div class="modal-content wide-modal">
        <h2>Trip Planning Checklist</h2>
        <div id="todosList">
            <!-- Todos will be populated here -->
        </div>
        <div class="button-group" style="justify-content: center; margin-top: 20px;">
            <button type="button" class="save-btn" onclick="saveTodos()">Save Checklist</button>
            <button type="button" class="cancel-btn" onclick="closeTodosModal()">Close</button>
        </div>
    </div>
</div>

<style>
/* New header styles */
.itinerary-header {
    text-align: center;
    padding: 40px 0;
    background: rgba(135, 150, 207, 0.2);
    backdrop-filter: blur(10px);
    margin-bottom: 40px;
    border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.itinerary-header h1 {
    font-size: 3em;
    color: #ffffff;
    margin: 0;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
    letter-spacing: 2px;
}

.itinerary-header h2 {
    font-size: 1.5em;
    color: rgba(255, 255, 255, 0.9);
    margin: 10px 0 0 0;
    font-weight: 400;
}

/* Existing styles with improvements */
.itinerary-container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 40px 20px;
    display: flex;
    flex-direction: column;
    align-items: center;
    background: transparent;
}

.itinerary-title {
    text-align: center;
    color: #ffffff;
    font-size: 2.5em;
    font-weight: 600;
    margin-bottom: 40px;
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
}

.day-container {
    position: relative;
    padding-left: 60px;
    margin-bottom: 50px;
    width: 100%;
}

.day-container h2 {
    font-size: 2em;
    color: #ffffff;
    margin: 60px 0 35px;
    padding: 15px 25px;
    border-radius: 12px;
    background: rgba(135, 150, 207, 0.2);
    backdrop-filter: blur(10px);
    text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 20px;
    z-index: 10;
    border: 1px solid rgba(255, 255, 255, 0.1);
}

.activity-row {
    position: relative;
    background: rgba(255, 255, 255, 0.15);
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 15px;
    margin: 20px 0;
    padding: 20px;
    width: 100%;
    box-sizing: border-box;
    transition: all 0.3s ease;
}

.activity-row:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
    background: rgba(135, 150, 207, 0.8);
}

.activity-row.visible {
    opacity: 1;
    transform: translateX(0);
}

.activity-content {
    display: grid;
    grid-template-columns: 150px 1fr 100px;
    gap: 20px;
    align-items: center;
}

.time-block {
    position: absolute;
    left: -140px;
    top: 50%;
    transform: translateY(-50%);
    width: 80px;
    text-align: right;
    opacity: 0;
    transition: opacity 0.4s ease;
    color: #ffffff;
    background: rgba(135, 150, 207, 0.3);
    font-size: 1.2em;
    font-weight: 500;
    padding: 8px 12px;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 6px;
}

.activity-row.visible .time-block {
    opacity: 1;
}

.activity-details h3 {
    color: #ffffff;
    margin: 0 0 5px 0;
    font-size: 1.2em;
    font-weight: 600;
    text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
}

.activity-details .location {
    color: rgba(255, 255, 255, 0.9);
    font-size: 0.95em;
    margin: 0;
}

.activity-details .cost {
    color: #ffffff;
    font-weight: 600;
    font-size: 1.1em;
    margin: 5px 0 0 0;
}

.edit-btn, .add-btn, .ship-btn, .save-btn, .delete-btn, .cancel-btn {
    background: rgba(255, 255, 255, 0.2);
    color: #ffffff;
    border: 1px solid rgba(255, 255, 255, 0.3);
    padding: 8px 16px;
    border-radius: 6px;
    font-weight: 500;
    transition: all 0.3s ease;
}

.edit-btn:hover, .add-btn:hover, .ship-btn:hover, 
.save-btn:hover, .delete-btn:hover, .cancel-btn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
}

.edit-btn {
    color: #8796cf;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
}

.add-btn {
    color: #6c8aff;
    padding: 8px 16px;
    border-radius: 4px;
    cursor: pointer;
    margin-top: 16px;
    font-size: 14px;
}

.ship-btn {
    color: #8796cf;
    padding: 10px 20px;
    font-size: 16px;
}

.modal {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.8);
    z-index: 1000;
}

.modal-content {
    background: rgba(255, 255, 255, 0.95);
    color: #161c1c;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(135, 150, 207, 0.2);
    box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
    transform: translateY(20px);
    transition: transform 0.3s ease;
    padding: 30px;
    border-radius: 10px;
    max-width: 500px;
    margin: 50px auto;
}

.modal.active .modal-content {
    transform: translateY(0);
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 5px;
    color: #161c1c;
    font-weight: 500;
}

.form-group input {
    width: 100%;
    padding: 8px;
    border: 1px solid rgba(135, 150, 207, 0.3);
    background: rgba(255, 255, 255, 0.8);
    color: #8796cf;
    border-radius: 4px;
    transition: all 0.3s ease;
}

.form-group input:focus {
    border-color: rgba(135, 150, 207, 0.6);
    box-shadow: 0 0 15px rgba(135, 150, 207, 0.1);
    outline: none;
}

.button-group {
    display: flex;
    justify-content: space-between;
    gap: 20px;
    margin-top: 20px;
    position: relative;
}

/* Only apply separator to the first button group */
.button-group:first-of-type::before {
    content: '';
    position: absolute;
    left: 50%;
    top: 0;
    bottom: 0;
    width: 1px;
    background-color: rgba(135, 150, 207, 0.2);
}

.save-btn {
    flex: 1;
}

.delete-btn {
    flex: 1;
}

.cancel-btn {
    flex: 1;
}

@media (max-width: 768px) {
    .activity-content {
        grid-template-columns: 1fr;
        gap: 10px;
    }
    
    .time-block, .activity-cost {
        text-align: left;
    }
    
    .itinerary-header h1 {
        font-size: 2em;
    }
    
    .itinerary-header h2 {
        font-size: 1.2em;
    }
    
    .itinerary-container {
        padding: 20px 10px;
    }
}

/* Add these new styles */
.header-actions {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 40px;
    width: 100%;
}

.wide-modal {
    max-width: 800px !important;
}

.todo-group {
    margin-bottom: 30px;
    padding: 20px;
    border: 1px solid rgba(135, 150, 207, 0.2);
    border-radius: 8px;
}

.todo-group h3 {
    color: #161c1c;
    font-size: 1.4em;
    margin-bottom: 15px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.todo-item {
    display: flex;
    align-items: center;
    margin: 10px 0;
    padding: 8px;
    background: rgba(135, 150, 207, 0.1);
    border-radius: 4px;
}

.todo-checkbox {
    margin-right: 10px;
    cursor: pointer;
}

.todo-label {
    color: #161c1c;
    flex-grow: 1;
}

.event-checkbox {
    margin-left: 10px;
    cursor: pointer;
}

/* Timeline container */
.timeline-line {
    position: absolute;
    left: 30px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: rgba(135, 150, 207, 0.3);
    transform: scaleY(0);
    transform-origin: top;
    transition: transform 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.timeline-line.visible {
    transform: scaleY(1);
}

/* Timeline dot for each activity */
.activity-row::before {
    content: '';
    position: absolute;
    left: -60px;
    top: 50%;
    width: 12px;
    height: 12px;
    background: #8796cf;
    border-radius: 50%;
    transform: translate(-50%, -50%) scale(0);
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    z-index: 1;
}

.activity-row.visible::before {
    transform: translate(-50%, -50%) scale(1);
}

/* Time connector line */
.activity-row::after {
    content: '';
    position: absolute;
    left: -54px;
    top: 50%;
    width: 20px;
    height: 2px;
    background: rgba(135, 150, 207, 0.3);
    transform: scaleX(0);
    transform-origin: left;
    transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.activity-row.visible::after {
    transform: scaleX(1);
}

/* Add this new style for the dynamic background */
body {
    margin: 0;
    min-height: 100vh;
    background: linear-gradient(180deg, #8796cf 0%, #161c1c 100%);
    background-attachment: fixed;
}
</style>

<script>
function convertTimeToMinutes(timeStr) {
    // Parse the time string (e.g., "8:00 AM" or "2:00 PM")
    const [time, period] = timeStr.split(' ');
    let [hours, minutes] = time.split(':').map(Number);
    
    // Convert to 24-hour format
    if (period === 'PM' && hours !== 12) {
        hours += 12;
    } else if (period === 'AM' && hours === 12) {
        hours = 0;
    }
    
    return hours * 60 + minutes;
}

function sortActivitiesInDay(dayContainer) {
    const activityContainer = dayContainer.querySelector('.activity-rows-container');
    const activities = Array.from(activityContainer.children);
    
    // Sort activities by start time
    activities.sort((a, b) => {
        const timeA = a.querySelector('.time-block').textContent.split(' to ')[0];
        const timeB = b.querySelector('.time-block').textContent.split(' to ')[0];
        return convertTimeToMinutes(timeA) - convertTimeToMinutes(timeB);
    });

    // Clear and re-append in sorted order
    activities.forEach(activity => activityContainer.appendChild(activity));
}

document.getElementById('editForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const activityId = document.getElementById('editActivityId').value;
    
    const formData = {
        title: document.getElementById('editTitle').value,
        start_time: convertTo12Hour(document.getElementById('editStartTime').value),
        end_time: convertTo12Hour(document.getElementById('editEndTime').value),
        location: document.getElementById('editLocation').value,
        cost: parseFloat(document.getElementById('editCost').value)
    };
    
    try {
        const response = await fetch(`/api/trip/event/${activityId}/modify`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        if (data.success) {
            // Instead of updating the UI directly, reload the page
            window.location.reload();
        } else {
            alert('Failed to update activity: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while updating the activity');
    }
});

// Sort all days on page load
document.addEventListener('DOMContentLoaded', function() {
    const dayContainers = document.querySelectorAll('.day-container');
    dayContainers.forEach(sortActivitiesInDay);
});

function convertTo12Hour(timeStr) {
    if (!timeStr) return '';
    
    // If already in 12-hour format with AM/PM, return as is
    if (timeStr.match(/^(0?[1-9]|1[0-2]):[0-5][0-9] [AP]M$/)) return timeStr;
    
    // Handle 24-hour format (e.g., "14:00" or "14:30")
    if (timeStr.match(/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/)) {
        const [hours, minutes] = timeStr.split(':').map(Number);
        const period = hours >= 12 ? 'PM' : 'AM';
        const twelveHour = hours % 12 || 12;
        return `${twelveHour}:${minutes.toString().padStart(2, '0')} ${period}`;
    }
    
    return timeStr; // Return original if format not recognized
}

function convertTo24Hour(timeStr) {
    if (!timeStr) return '';
    // If already in 24-hour format, return as is
    if (timeStr.match(/^([01]?[0-9]|2[0-3]):[0-5][0-9]$/)) return timeStr;
    
    const [time, period] = timeStr.split(' ');
    let [hours, minutes] = time.split(':').map(Number);
    
    if (period === 'PM' && hours !== 12) {
        hours += 12;
    } else if (period === 'AM' && hours === 12) {
        hours = 0;
    }
    
    return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}`;
}

function showModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.style.display = 'block';
    modal.classList.add('active');
}

function hideModal(modalId) {
    const modal = document.getElementById(modalId);
    modal.classList.remove('active');
    setTimeout(() => modal.style.display = 'none', 300);
}

function editActivity(activityId) {
    showModal('editModal');
    const modal = document.getElementById('editModal');
    const activity = document.querySelector(`div[data-id="${activityId}"]`);
    
    if (!activity) {
        console.error('Activity element not found for ID:', activityId);
        return;
    }
    
    // Get the time elements and cost
    const timeBlock = activity.querySelector('.time-block').textContent;
    const [startTime, endTime] = timeBlock.split('to').map(t => t.trim());
    const cost = activity.querySelector('.cost').textContent.replace('$', '');
    
    // Populate form with current values
    document.getElementById('editActivityId').value = activityId;
    document.getElementById('editTitle').value = activity.querySelector('h3').textContent;
    document.getElementById('editStartTime').value = convertTo24Hour(startTime);
    document.getElementById('editEndTime').value = convertTo24Hour(endTime);
    document.getElementById('editLocation').value = activity.querySelector('.location').textContent;
    document.getElementById('editCost').value = cost;
}

function closeModal() {
    hideModal('editModal');
}

function deleteActivity(activityId) {
    if (confirm('Are you sure you want to delete this event?')) {
        fetch(`/api/trip/event/${activityId}/delete`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                closeModal();
                window.location.reload();
            } else {
                alert('Failed to delete activity: ' + data.error);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while deleting the activity');
        });
    }
}

function showAddModal(dayDate) {
    showModal('addModal');
    const modal = document.getElementById('addModal');
    document.getElementById('addDayDate').value = dayDate;
    document.getElementById('addForm').reset();
}

function closeAddModal() {
    hideModal('addModal');
}

document.getElementById('addForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = {
        day_date: document.getElementById('addDayDate').value,
        title: document.getElementById('addTitle').value,
        start_time: convertTo12Hour(document.getElementById('addStartTime').value),
        end_time: convertTo12Hour(document.getElementById('addEndTime').value),
        location: document.getElementById('addLocation').value,
        cost: parseFloat(document.getElementById('addCost').value)
    };
    
    try {
        const response = await fetch('/api/trip/event/add', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        const data = await response.json();
        if (data.success) {
            window.location.reload();
        } else {
            alert('Failed to add activity: ' + data.error);
        }
    } catch (error) {
        console.error('Error:', error);
        alert('An error occurred while adding the activity');
    }
});

// Close modals when clicking outside
window.onclick = function(event) {
    const addModal = document.getElementById('addModal');
    const editModal = document.getElementById('editModal');
    const todosModal = document.getElementById('todosModal');
    if (event.target == addModal) {
        closeAddModal();
    } else if (event.target == editModal) {
        closeModal();
    } else if (event.target == todosModal) {
        closeTodosModal();
    }
}

function generateTodos(activity) {
    const todos = [];
    const title = activity.title.toLowerCase();
    
    // Transportation related todos
    if (title.includes('travel') || title.includes('flight') || title.includes('train') || title.includes('bus')) {
        todos.push('Book transportation tickets');
        todos.push('Check visa requirements');
        todos.push('Arrange airport/station transfer');
        todos.push('Download travel documents');
    }
    
    // Restaurant related todos
    if (title.includes('dinner') || title.includes('lunch') || title.includes('restaurant')) {
        todos.push('Make restaurant reservation');
        todos.push('Check dress code');
        todos.push('Confirm dietary requirements');
    }
    
    // Museum/attraction related todos
    if (title.includes('museum') || title.includes('gallery') || title.includes('tour')) {
        todos.push('Book tickets in advance');
        todos.push('Check opening hours');
        todos.push('Research guided tour options');
    }
    
    // Hotel/accommodation related todos
    if (title.includes('hotel') || title.includes('check-in') || title.includes('accommodation')) {
        todos.push('Confirm reservation');
        todos.push('Request early check-in/late check-out');
        todos.push('Save hotel contact information');
    }
    
    return todos;
}

function shipItinerary() {
    const modal = document.getElementById('todosModal');
    const todosList = document.getElementById('todosList');
    todosList.innerHTML = '';
    
    // Collect all activities
    const activities = document.querySelectorAll('.activity-row');
    
    activities.forEach(activity => {
        const title = activity.querySelector('h3').textContent;
        const time = activity.querySelector('.time-block').textContent;
        const location = activity.querySelector('.location').textContent;
        
        const todos = generateTodos({title, time, location});
        
        if (todos.length > 0) {
            const todoGroup = document.createElement('div');
            todoGroup.className = 'todo-group';
            
            const header = document.createElement('h3');
            header.innerHTML = `
                ${title}
                <input type="checkbox" class="event-checkbox" title="Mark event as confirmed">
            `;
            
            const todoItems = todos.map(todo => `
                <div class="todo-item">
                    <input type="checkbox" class="todo-checkbox">
                    <span class="todo-label">${todo}</span>
                </div>
            `).join('');
            
            todoGroup.innerHTML = header.outerHTML + todoItems;
            todosList.appendChild(todoGroup);
        }
    });
    
    modal.style.display = 'block';
}

function closeTodosModal() {
    hideModal('todosModal');
}

function saveTodos() {
    // Here you would typically save the state of all checkboxes
    // For now, we'll just show a success message
    alert('Checklist saved!');
    closeTodosModal();
}

// Intersection Observer for scroll animations
document.addEventListener('DOMContentLoaded', function() {
    // Add timeline to each day container
    document.querySelectorAll('.day-container').forEach(container => {
        const timeline = document.createElement('div');
        timeline.className = 'timeline-line';
        container.appendChild(timeline);
    });

    // Enhanced Intersection Observer
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                entry.target.classList.add('visible');
                
                // If it's a day container, show its timeline
                if (entry.target.classList.contains('day-container')) {
                    const timeline = entry.target.querySelector('.timeline-line');
                    if (timeline) timeline.classList.add('visible');
                    
                    // Animate activities in sequence
                    const activities = entry.target.querySelectorAll('.activity-row');
                    activities.forEach((activity, index) => {
                        setTimeout(() => {
                            activity.classList.add('visible');
                        }, index * 200); // Staggered delay
                    });
                }
            }
        });
    }, {
        threshold: 0.1,
        rootMargin: '0px 0px -50px 0px'
    });

    // Observe day containers and activities
    document.querySelectorAll('.day-container, .activity-row').forEach(el => {
        observer.observe(el);
    });

    // Sort activities by time within each day
    document.querySelectorAll('.day-container').forEach(day => {
        const activities = Array.from(day.querySelectorAll('.activity-row'));
        activities.sort((a, b) => {
            const timeA = a.querySelector('.time-block').textContent.split(' to ')[0];
            const timeB = b.querySelector('.time-block').textContent.split(' to ')[0];
            return convertTimeToMinutes(timeA) - convertTimeToMinutes(timeB);
        });
        
        const container = day.querySelector('.activity-rows-container');
        activities.forEach(activity => container.appendChild(activity));
    });
});

// Helper function to convert time to minutes for sorting
function convertTimeToMinutes(time) {
    const [rawTime, period] = time.split(' ');
    let [hours, minutes] = rawTime.split(':').map(Number);
    
    if (period === 'PM' && hours !== 12) {
        hours += 12;
    } else if (period === 'AM' && hours === 12) {
        hours = 0;
    }
    
    return hours * 60 + minutes;
}

// Add this new function for dynamic background
function updateBackgroundGradient() {
    const scrollPosition = window.scrollY;
    const documentHeight = document.documentElement.scrollHeight - window.innerHeight;
    const scrollPercentage = (scrollPosition / documentHeight) * 100;
    
    // Calculate gradient stops based on scroll position
    const dayColor = '#8796cf';
    const nightColor = '#161c1c';
    
    // Create gradient with three color stops for smoother transition
    document.body.style.background = `
        linear-gradient(180deg,
        ${dayColor} 0%,
        ${calculateIntermediateColor(dayColor, nightColor, scrollPercentage)} ${scrollPercentage}%,
        ${nightColor} 100%)
    `;
}

function calculateIntermediateColor(color1, color2, percentage) {
    // Convert hex to RGB
    const r1 = parseInt(color1.slice(1, 3), 16);
    const g1 = parseInt(color1.slice(3, 5), 16);
    const b1 = parseInt(color1.slice(5, 7), 16);
    
    const r2 = parseInt(color2.slice(1, 3), 16);
    const g2 = parseInt(color2.slice(3, 5), 16);
    const b2 = parseInt(color2.slice(5, 7), 16);
    
    // Calculate intermediate values
    const r = Math.round(r1 + (r2 - r1) * (percentage / 100));
    const g = Math.round(g1 + (g2 - g1) * (percentage / 100));
    const b = Math.round(b1 + (b2 - b1) * (percentage / 100));
    
    // Convert back to hex
    return `#${(r << 16 | g << 8 | b).toString(16).padStart(6, '0')}`;
}

// Add scroll event listener
window.addEventListener('scroll', updateBackgroundGradient);
document.addEventListener('DOMContentLoaded', updateBackgroundGradient);

// Add date range functionality
document.addEventListener("DOMContentLoaded", function () {
    fetch("/api/trip/events")
        .then(response => response.json())
        .then(data => {
            if (data.success && data.events.length > 0) {
                const startDate = data.events[0].date;
                const endDate = data.events[data.events.length - 1].date;
                document.getElementById("trip-date-range").innerText = 
                    new Date(startDate).toLocaleDateString() + " - " +
                    new Date(endDate).toLocaleDateString();
            }
        });
});
</script>

<script src="{{ url_for('static', filename='itinerary.js') }}"></script>
{% endblock %}
